inet_interfaces = all
mynetworks = 127.0.0.0/8 [::ffff:127.0.0.0]/104 [::1]/128
readme_directory = no

myhostname = <%= node[:fqdn] %>
myorigin = /etc/mailname
mydestination = $myhostname, localhost
alias_maps = hash:/etc/aliases
alias_database = hash:/etc/aliases
virtual_alias_domains = <%= node[:'mail-server'][:virtual_alias_domains].join(' ') %>
virtual_alias_maps = hash:/etc/postfix/virtual
smtp_generic_maps = regexp:/etc/postfix/generic
append_dot_mydomain = no

mailbox_size_limit = 0
recipient_delimiter = +
home_mailbox = Maildir/
mailbox_command = /usr/lib/dovecot/deliver -c /etc/dovecot/conf.d/01-mail-stack-delivery.conf -n -m "${EXTENSION}"
biff = no

soft_bounce = yes
delay_warning_time = 4h
#notify_classes = bounce,resource,software

smtp_sasl_auth_enable = yes
smtp_sasl_password_maps = hash:/etc/postfix/sasl_password
smtp_sasl_security_options = noanonymous
header_size_limit = 4096000
relayhost = <%= node[:'mail-server'][:relayhost] %>

smtpd_banner = $myhostname ESMTP $mail_name (Ubuntu)

smtp_use_tls = yes
smtp_tls_session_cache_database = btree:${data_directory}/smtp_scache
smtp_tls_security_level = may

smtpd_sasl_auth_enable = yes
smtpd_sasl_type = dovecot
smtpd_sasl_path = private/dovecot-auth
smtpd_sasl_authenticated_header = yes
smtpd_sasl_security_options = noanonymous
smtpd_sasl_local_domain = $myhostname

smtpd_use_tls=yes
smtpd_tls_cert_file = /etc/ssl/certs/ssl-mail.pem
smtpd_tls_key_file = /etc/ssl/private/ssl-mail.key
smtpd_tls_session_cache_database = btree:${data_directory}/smtpd_scache
smtpd_tls_received_header = yes
smtpd_tls_mandatory_protocols = SSLv3, TLSv1
smtpd_tls_mandatory_ciphers = medium
smtpd_tls_auth_only = yes

smtpd_client_restrictions =
 permit_mynetworks,
 check_client_access hash:/etc/postfix/access_client
smtpd_sender_restrictions =
 permit_mynetworks,
 reject_non_fqdn_sender,
 reject_unknown_sender_domain
smtpd_recipient_restrictions =
 permit_mynetworks,
 permit_sasl_authenticated,
 reject_unauth_pipelining,
 reject_non_fqdn_recipient,
 reject_unknown_recipient_domain,
 reject_unauth_destination,
 check_sender_access hash:/etc/postfix/access_sender,
 reject_rbl_client zen.spamhaus.org,
 check_policy_service unix:private/policy-spf

content_filter = smtp-amavis:127.0.0.1:10024
spf-policyd_time_limit = 3600s
disable_vrfy_command = yes
smtpd_delay_reject = yes
smtpd_helo_required = yes
